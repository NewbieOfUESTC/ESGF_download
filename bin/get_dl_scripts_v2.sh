#!/bin/bash

# shell scripts for downloading CMIP6 climate model data from ESGF used at the 
# Norwegian Meteorological Institute in conjunction with the KeyClim project.

# Home page: https://github.com/metno/ESGF_download

# 

if [[ $# -lt 1 ]] 
	then echo "usage: ${0} <dl directory> [-a | <experiment> [<experiment2>]]"
	echo <dl directory> : directory where the download scripts are stored
	echo "-a            : read experiments from the file experiments_all.txt and the vars from vars_all.txt"
	echo "<experiment>  : list of CMIP6 experiment names"
	echo "                if experiment is not given, the ones from the file experiments.txt is used"
	echo
	echo example: ${0} ../dl_scripts/ piControl
	exit
fi
bin_dir=`realpath ${0}`
scriptdir=`realpath ${1}`
shift
bin_dir=`dirname ${bin_dir}`

. ./script_include.sh

if [ $# -ge 1 ]
	then
	if [[ ${1} == '-a' ]]
		then 
		experiments=(${experiments_all[*]})
		vars=(${vars_all[*]})
		echo "debug: running experiments from file experiments_all.txt"
	else
		echo "debug: experiments on the command line given"
		experiments=($@)
	fi
else
	# $# is 0
	#use vars.txt and experiments.txt
	echo using variables from vars.txt and experiments from experiments.txt
fi
echo -n "debug: running experiments "
echo ${experiments[*]}
echo -n "debug: running variables "
echo ${vars[*]}
runfile="./runfile_${logdate}_${UUID}_${HOSTNAME}.run"
rm -f "${runfile}"
DryRunFlag=0

# http://esgf-data.dkrz.de/esg-search/search/?offset=0&limit=10&type=Dataset&replica=false&latest=true&variable_id=abs550aer&realm=aerosol&activity_id%21=input4MIPs&variant_label=r1i1p1f1&frequency=mon&mip_era=CMIP6&facets=mip_era%2Cactivity_id%2Cmodel_cohort%2Cproduct%2Csource_id%2Cinstitution_id%2Csource_type%2Cnominal_resolution%2Cexperiment_id%2Csub_experiment_id%2Cvariant_label%2Cgrid_label%2Ctable_id%2Cfrequency%2Crealm%2Cvariable_id%2Ccf_standard_name%2Cdata_node&format=application%2Fsolr%2Bjson

#download_structure=project,product,institute,model,experiment,time_frequency,realm,cmor_table,ensemble,variable
#download_structure=,experiment,model,variant_label
for VAR in ${vars[*]}
	do echo ${VAR}
	for EXPERIMENT in ${experiments[*]}
		do echo ${EXPERIMENT}
			script_url="https://esgf-data.dkrz.de/esg-search/wget?mip_era=CMIP6&variable=${VAR}&experiment_id=${EXPERIMENT}&variant_label=${VARIANT_LABEL}&realm=${REALM}&frequency=${FREQUENCY}&limit=9999&download_structure=experiment_id,source_id,variant_label"
			script_file="${scriptdir}/${VAR}_${EXPERIMENT}_${VARIANT_LABEL}.sh"
			wget -O ${script_file} ${script_url}
			chmod u+x,g+x ${script_file}
			logfile="${logdir}/${VAR}_${EXPERIMENT}_${VARIANT_LABEL}_${logdate}.log"
			#use the following line in case you want to redirect STDERR to the log file as well
			#the progress bars generated by wget will increase the size of the log file in this case
			#echo "${exec_script} ${script_file} ${dl_dir} >> ${logfile} 2>&1" >> "${runfile}"
			echo "${exec_script} ${script_file} ${dl_dir} >> ${logfile}" >> "${runfile}"
	done
done

echo command line for GNU parallel
echo ========================================================
echo /usr/bin/parallel -v -j ${SlotsToUse} -a "${runfile}"
exit

# Remove the upper exit command to run the commands directly

if [ ${DryRunFlag} -eq 0 ]
   then
   echo Starting parallel for to download...
   set -x
   /usr/bin/parallel -v -j ${SlotsToUse} -a "${runfile}"
   set +x
else
   #dry run: list commands in to be executed order
   echo "DRY-RUN!"
   /usr/bin/parallel --dry-run -v -j ${SlotsToUse} -a "${runfile}"
fi

#http://esgf-data.dkrz.de/esg-search/search/?offset=0&limit=9999&type=Dataset&replica=false&latest=true&variable_id=thetao&experiment_id=abrupt-4xCO2%2Chistorical%2CpiControl&variant_label=r1i1p1f1&mip_era=CMIP6&activity_id%21=input4MIPs&source_id=CESM2&grid_label=gr&facets=mip_era%2Cactivity_id%2Cmodel_cohort%2Cproduct%2Csource_id%2Cinstitution_id%2Csource_type%2Cnominal_resolution%2Cexperiment_id%2Csub_experiment_id%2Cvariant_label%2Cgrid_label%2Ctable_id%2Cfrequency%2Crealm%2Cvariable_id%2Ccf_standard_name%2Cdata_node&format=application%2Fsolr%2Bjson
